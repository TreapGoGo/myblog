---
title: Uniswap V2核心白皮书 中文翻译
date: 2023-09-12 16:53:42
categories: Web3
tags: ["Web3", "Defi", "DEX", "Uniswap"]
---

# 译者注

本文是对《Uniswap v2 Core》的中文翻译，原文的版权属于原作者或原著作权持有人。本翻译文档受到 MIT 许可协议的保护。请在使用本文档之前仔细阅读并遵守 MIT 许可协议的规定。

原文链接：https://docs.uniswap.org/whitepaper.pdf

<center><h1>Uniswap V2 核心</h1></center>

作者：

Hayden Adams - hayden@uniswap.org

Noah Zinsmeister - noah@uniswap.org

Dan Robinson - dan@paradigm.xyz

2020年3月

# 摘要

这份技术白皮书解释了 Uniswap V2 核心合约背后的若干设计决策。其内容涵盖了合约的一些新特性，其中包括

* 任意 ERC20 代币的交易币对；
* 一个经过加强的预言机：这个预言机使得其他合约可以预估某个给定的时间范围内的时间加权均价；
* “闪电兑”：这种交换方式允许交易者先收到资产并在其他地方使用资产，然后再在交易的最后为这些资产支付费用；
* 一个可以在未来开启的协议费。

这份白皮书描述了 Uniswap V2 的“核心”合约的机制，这些合约包括存有流动性提供者资金的币对合约，以及用于实例化币对合约的工厂合约。

# 1 介绍

Uniswap V1 是一个以太坊区块链上的链上智能合约系统，实现了一个基于“恒定乘积公式”的流动性协议。每个 Uniswap V1 币对都存放着两种资产的合并存量，并且为这两种资产提供流动性，保持两种资产的数量之积是一个不会下降的常量。交易者在交易时支付 30 个基点的费用，作为给流动性提供者的报酬。这些合约是不可升级的。

Uniswap V2 是一个基于相同公式的全新实现，同时具有一些万众瞩目的新特性。其中最重要的是， Uniswap V2 使得创建任意的 ERC20/ERC20 交易对成为可能，而不是只支持 ERC20 和 ETH 之间的交易对。 Uniswap V2 也提供了一个经过加强的价格预言机，这个预言机在每个区块开始时就收集两种资产相关的价格信息。这使得以太坊上的其他合约可以估算两个资产在任意时间范围内的时间加权均价。最后， Uniswap V2 使得“闪电兑”成为可能，通过闪电兑，用户可以自由地收到资产并且将他们用在链上的其他地方，只需要在交易的最后支付或归还这些资产即可。

尽管合约通常是不可升级的，但是依然存在一个私钥拥有更新工厂合约中的一个变量来开启链上 5 个基点交易费的能力。这个费用起初处于关闭状态，但可以在未来被开启。开启后，流动性提供者每次交易将赚取 25 个基点的报酬，而不是 30 个基点。

正如第 3 部分所述， Uniswap V2 也修复了 Uniswap V1 中的一些小错误，同时重构了实现方式，通过最小化存放流动性提供者资金的“核心”合约的逻辑降低了 Uniswap 的攻击面，并且使得该系统更容易升级。

这篇论文描述了核心合约以及用于实例化核心合约的工厂合约的运行机制。实际上使用 Uniswap V2 将需要通过一个“路由”合约来调用币对合约，而“路由”合约可以计算交易或储蓄的数量并向币对合约发送资产。

# 2 新特性

## 2.1 ERC-20 交易对

Uniswap V1 使用 ETH 作为过渡货币。每一个交易对都包含 ETH 作为其中一项资产。这使得寻找交易路径变得更加简单（代币 ABC 和代币 XYZ 之间的交易可以通过 ETH/ABC 交易对和 ETH/XYZ 交易对来实现），也减少了流动性的分散。

然而，这个规则给流动性提供者带来了巨大的费用。所有的流动性提供者都有 ETH 的敞口，并且承受了基于其他与 ETH 有关的资产价格变动而带来的无常损失。当 ABC 和 XYZ 两种资产价格相关时（例如他们俩都是锚定美元的稳定币）， ABC/XYZ 交易对的流动性提供者所承受的无常损失通常小于 ABC/ETH 交易对或 XYZ/ETH 交易对的流动性提供者。

使用 ETH 作为强制性的过渡货币也给交易者带来了费用。相比于直接交易 ABC/XYZ 币对，交易者需要支付两倍的交易费，还要承受两次滑点。

Uniswap V2 允许流动性提供者创建任意两种 ERC-20 代币的交易对合约。

任意 ERC20 代币之间的交易对数量激增，可能会导致为一个特定交易对寻找最佳交易路径的过程变得稍加困难，但是路由工作可以在更高的层级被解决（要么在链下解决，要么通过链上的路由器或聚合器）。

## 2.2 价格预言机

在 $t$ 时刻， Uniswap 提供的边际价格（不包括费用）可以通过 $a$ 资产储备量除以 $b$ 资产储备量计算出来。

$$
p_t=\frac{r_t^a}{r_t^b}
$$

由于如果价格偏离了正确值，套利者就会用 Uniswap 交易套利使得价格回归正确值（如果价格偏离程度足够弥补交易费用的话）， Uniswap 提供的价格倾向于追踪该资产的相关市场价格，正如参考文献 2 中 Angeris 展示的那样。这意味着 Uniswap 可以被用作一个大致性的价格预言机。

然而， Uniswap V1 作为链上价格预言机并不安全，因为它很容易被操纵。假设某个其他合约使用当前的 ETH-DAI 价格来结算一种衍生品。一个希望操纵测定价格的攻击者可以从 ETH-DAI 交易对中购买 ETH ，触发衍生品合约的结算（这导致衍生品以一个过高的价格结算了），然后以正确的价格将 ETH 卖回交易对中。这甚至有可能在一次基本交易中完成，或者被一个在区块内控制交易顺序的矿工完成。

Uniswap V2 通过测量并记录每个区块第一笔交易**之前**的价格来提高这个预言机的功能性（或者等价地，每个区块最后一笔交易**之后**的价格）。这个价格比区块挖掘期间的价格更加难以操纵。如果攻击者在区块的最后发送了一个试图操纵价格的交易，某些其他的套利者就可以在同一个区块靠后的位置发送另一笔的交易从而立即将价格归位。一个矿工（或者一个使用足够多燃料费填满整个区块的攻击者）可以操纵区块末尾的价格，但是，如果他们没能继续担任下一个区块的矿工，他们就没法阻止套利者将价格归位。


具体来说， Uniswap V2 通过追踪每一个包含交互调用的区块开始时的价格累和，将这些价格加总在一起。根据区块的时间戳，每一个价格将按照该价格所持续的时间为依据赋予权重。这意味着在价格更新后任意给定时间的累计值应该等于合约历史上每一秒的价格之和。

$$
a_t=\sum_{i=1}^t p_i
$$

想要预估从 $t_1$ 时刻到 $t_2$ 时刻的**时间加权均价**，一个外部的调用者可以读取 $t_1$ 时刻和 $t_2$ 时刻的累计价格，用 $t_2$ 时刻的累计价格减去 $t_1$ 时刻的累计价格，然后除以经过的时间。（需要注意的是，合约自身并不存储价格的累计值，调用者不得在周期开始的时候自行调用合约读取并存储这个值。）

$$
p_{t_1,t_2}
=\frac{\sum_{i=t_1}^{t_2} p_i}{t_2-t_1}
=\frac{\sum_{i=1}^{t_2} p_i - \sum_{i=1}^{t_1} p_i}{t_2-t_1}
=\frac{a_{t_2}-a{t_1}}{t_2-t_1}
$$

预言机的用户可以选择周期开始和结束的时间。选择更长的周期可以让攻击者为操纵时间加权均价付出更大的代价，但这样也会使得价格有所滞后。

